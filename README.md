# AstrBot Lark Enhance Plugin (飞书体验增强插件)

`lark_enhance` 是一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的插件，旨在深度优化飞书（Lark/Feishu）平台的使用体验。它通过注入更丰富的上下文信息、解析真实用户昵称以及提供原生表情互动能力，让你的机器人更加智能、自然。

## ✨ 主要功能

### 1. 👥 真实姓名解析
告别冰冷的 `ou_xxx` 用户 ID。插件会自动将消息中的 OpenID 解析为飞书通讯录中的真实昵称，让 LLM 知道它在和谁对话。
- **发送者昵称**：自动补全发送者的真实姓名。
- **@提及解析**：将消息中的 `@ou_xxx` 自动替换为 `@张三`，方便模型理解提及关系。

### 2. 💬 引用消息穿透
当用户回复某条消息时，LLM 通常无法看到原消息内容。
本插件会自动抓取用户引用的消息内容，并将其作为背景信息注入到 Prompt 中，让 LLM 能够理解“回复”的上下文。

### 3. 🏘️ 群聊上下文感知 (Local Context)
在群聊场景中，用户往往省略背景信息直接提问。
- **本地滑动窗口**：插件会在本地内存中维护一个短期的群聊消息记录（默认最近 20 条）。
- **智能注入**：当你与机器人对话时，它能“看到”群里刚才发生的讨论，从而做出更符合语境的回答，而不仅仅是基于你这一句话。
- **隐私安全**：历史记录仅保存在内存中，重启即焚，绝不持久化到磁盘。

### 4. 😀 原生表情回复工具
赋予 LLM 使用飞书原生表情（Reactions）的能力。
- **情感表达**：模型可以使用工具给用户的消息贴上 👍、❤️、😂 等表情。
- **静默执行**：模型贴表情后不会再啰嗦一句“我已经贴了表情”，保持对话清爽。

### 5. 🧹 上下文清洗
针对 Gemini 等模型对 `tool_calls` 格式敏感的问题，插件会自动清洗历史上下文中的工具调用记录，将其转换为模型易读的文本描述，避免 API 报错。

## ⚙️ 配置说明

插件支持通过 AstrBot 仪表盘或直接修改配置文件进行配置。

| 配置项 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `enable_real_name` | bool | `true` | 是否启用真实姓名解析。 |
| `enable_quoted_content` | bool | `true` | 是否启用引用消息内容注入。 |
| `enable_group_info` | bool | `true` | 是否注入群组信息（如群名）。 |
| `enable_context_cleaner` | bool | `true` | 是否启用上下文清洗（推荐开启，尤其是使用 Gemini 时）。 |
| `history_inject_count` | int | `20` | **群聊历史记录数量**。设置为 0 可禁用。插件会记录群内最近 N 条消息作为上下文。 |
| `enable_streaming_card` | bool | `false` | (实验性) 是否使用卡片流式输出。 |

## 🚀 安装与使用

1. 将本插件目录放入 AstrBot 的 `data/plugins/` 目录下。
2. 重启 AstrBot。
3. 在仪表盘中激活插件（通常自动激活）。
4. 在飞书群聊中 @机器人 即可体验增强后的效果。

## ⚠️ 注意事项

- **权限要求**：为了获取真实昵称和群聊历史，飞书机器人应用需要开通相应的 **获取联系人信息** 和 **获取群组消息** 权限。
- **历史记录**：群聊历史记录依赖于插件运行时的实时抓取，重启 AstrBot 后历史记录会清空，需要有新消息产生才会重新积累上下文。

## 📝 License

MIT
