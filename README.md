# AstrBot Lark Enhance Plugin (飞书体验增强插件)

`lark_enhance` 是一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的插件，旨在深度优化飞书（Lark/Feishu）平台的使用体验。它通过注入更丰富的上下文信息、解析真实用户昵称、流式卡片输出、用户记忆以及提供原生表情互动能力，让你的机器人更加智能、自然。

## ✨ 主要功能

### 1. 👥 真实姓名解析
告别冰冷的 `ou_xxx` 用户 ID。插件会自动将消息中的 OpenID 解析为飞书通讯录中的真实昵称，让 LLM 知道它在和谁对话。
- **发送者昵称**：自动补全发送者的真实姓名。
- **@提及解析**：将消息中的 `@ou_xxx` 自动替换为 `@张三`，方便模型理解提及关系。

### 2. 💬 引用消息穿透
当用户回复某条消息时，LLM 通常无法看到原消息内容。
本插件会自动抓取用户引用的消息内容，并将其作为背景信息注入到 Prompt 中，让 LLM 能够理解"回复"的上下文。
- 如果被引用消息包含图片，插件会把图片作为多模态输入一并注入当前请求（使用 AstrBot 当前配置的多模态模型能力）。

### 3. 🏘️ 群聊上下文感知
在群聊场景中，用户往往省略背景信息直接提问。
- **滑动窗口记录**：插件会维护群聊消息记录（默认最近 20 条），并持久化存储。
- **智能注入**：当你与机器人对话时，它能"看到"群里刚才发生的讨论，从而做出更符合语境的回答。
- **群组信息**：自动注入群名称和群描述，帮助 LLM 理解对话场景。
- **重启保留**：历史记录会保存到本地文件，重启后自动恢复。

### 4. 🧠 用户记忆系统
让机器人记住每个用户的偏好和信息，提供个性化交互体验。
- **按群隔离**：每个群的记忆独立存储，不会相互影响。
- **三种记忆类型**：
  - `instruction`：持久指令（如"总是用英文回复"）
  - `preference`：用户偏好（如称呼、回复风格）
  - `fact`：用户事实（如职业、项目）
- **自然交互**：用户可以通过自然语言让机器人记住信息，如"记住我叫小王"。
- **持久化存储**：记忆保存到本地文件，重启后自动恢复。

### 5. ⌨️ 流式卡片输出（打字机效果）
使用飞书消息卡片实现实时流式输出，让回复过程更加生动。
- **实时更新**：LLM 生成内容时，卡片会实时更新显示。
- **加载指示**：输出过程中显示"正在输入..."指示器。
- **需要配合**：需要在 AstrBot 中启用 LLM 流式输出功能。

### 6. 🔗 @ 提及转换
让 LLM 能够真正 @ 群成员。
- **智能识别**：当 LLM 回复中包含 `@张三` 时，自动转换为飞书原生的 @ 提及。
- **群成员匹配**：基于群成员列表进行精确匹配，确保 @ 到正确的人。

### 7. 😀 原生表情回复工具
赋予 LLM 使用飞书原生表情（Reactions）的能力。
- **情感表达**：模型可以使用工具给用户的消息贴上 👍、❤️、😂 等表情。
- **防刷屏**：每条消息最多只能添加一个表情回复。

### 8. 🌡️ 群聊氛围感知
机器人会基于最近群聊内容判断当前氛围（如欢乐整活、轻求助、日常聊天），自动调整回复语气和结构。

### 9. 🧩 群梗记忆
支持记录和注入群内常用梗，减少“机器人味”。
- 自动识别“记住这个梗：xxx”类消息并存储。
- 复用记忆工具：`lark_save_memory` / `lark_list_memory` / `lark_forget_memory`（通过 `memory_type="meme"` 管理群梗）。

### 10. 🗣️ 拟人节奏控制
通过系统提示约束回复节奏：优先短句、先接话再回答、句式多样，避免模板化客服口吻。

## ⚙️ 配置说明

插件支持通过 AstrBot 仪表盘或直接修改配置文件进行配置。

| 配置项 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `enable_real_name` | bool | `true` | 是否启用真实姓名解析 |
| `enable_quoted_content` | bool | `true` | 是否启用引用消息内容注入 |
| `enable_group_info` | bool | `true` | 是否注入群组信息（群名、群描述） |
| `enable_streaming_card` | bool | `false` | 是否启用流式卡片输出（打字机效果，需要同时开启 AstrBot 流式输出） |
| `enable_vibe_sense` | bool | `true` | 是否启用群聊氛围感知 |
| `enable_meme_memory` | bool | `true` | 是否启用群梗记忆 |
| `enable_human_rhythm` | bool | `true` | 是否启用拟人节奏控制 |
| `enable_mention_convert` | bool | `true` | 是否将 LLM 回复中的 @名字 转换为飞书 @ 提及 |
| `enable_user_memory` | bool | `true` | 是否启用用户记忆功能 |
| `history_inject_count` | int | `20` | 群聊历史记录数量，设置为 0 可禁用 |
| `memory_inject_limit` | int | `10` | 每次注入的用户记忆数量上限 |
| `memory_max_per_user` | int | `20` | 每个用户的最大记忆条数 |
| `memory_max_per_group` | int | `30` | 每个群的群维度记忆条数上限 |
| `bot_name` | string | `"助手"` | 机器人在群聊历史记录中显示的名称 |

## 🚀 安装与使用

1. 将本插件目录放入 AstrBot 的 `data/plugins/` 目录下。
2. 安装依赖：`pip install -r requirements.txt`
3. 重启 AstrBot。
4. 在仪表盘中激活插件（通常自动激活）。
5. 在飞书群聊中 @机器人 即可体验增强后的效果。

## ⚠️ 注意事项

- **权限要求**：为了获取真实昵称和群成员信息，飞书机器人应用需要开通相应的 API 权限：
  - `contact:user.base:readonly` - 获取用户基本信息
  - `im:chat:readonly` - 获取群组信息
  - `im:chat.member:readonly` - 获取群成员列表
  - `im:message:readonly` - 获取消息内容
- **流式输出**：使用流式卡片功能前，请确保在 AstrBot 的 LLM 配置中启用了流式输出。
- **数据存储**：
  - 群聊历史记录存储在 `data/plugin_data/astrbot_plugin_lark_enhance/group_history.json`
  - 用户记忆存储在 `data/plugin_data/astrbot_plugin_lark_enhance/user_memory/` 目录下

## 📝 License

MIT
