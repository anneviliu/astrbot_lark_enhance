# AstrBot Lark Enhance Plugin (飞书体验增强插件)

`lark_enhance` 是一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的插件，旨在深度优化飞书（Lark/Feishu）平台的使用体验。它通过注入更丰富的上下文信息、解析真实用户昵称、流式卡片输出以及提供原生表情互动能力，让你的机器人更加智能、自然。

## ✨ 主要功能

### 1. 👥 真实姓名解析
告别冰冷的 `ou_xxx` 用户 ID。插件会自动将消息中的 OpenID 解析为飞书通讯录中的真实昵称，让 LLM 知道它在和谁对话。
- **发送者昵称**：自动补全发送者的真实姓名。
- **@提及解析**：将消息中的 `@ou_xxx` 自动替换为 `@张三`，方便模型理解提及关系。

### 2. 💬 引用消息穿透
当用户回复某条消息时，LLM 通常无法看到原消息内容。
本插件会自动抓取用户引用的消息内容，并将其作为背景信息注入到 Prompt 中，让 LLM 能够理解"回复"的上下文。

### 3. 🏘️ 群聊上下文感知
在群聊场景中，用户往往省略背景信息直接提问。
- **滑动窗口记录**：插件会维护群聊消息记录（默认最近 20 条），并持久化存储。
- **智能注入**：当你与机器人对话时，它能"看到"群里刚才发生的讨论，从而做出更符合语境的回答。
- **群组信息**：自动注入群名称和群描述，帮助 LLM 理解对话场景。
- **重启保留**：历史记录会保存到本地文件，重启后自动恢复。

### 4. ⌨️ 流式卡片输出（打字机效果）
使用飞书消息卡片实现实时流式输出，让回复过程更加生动。
- **实时更新**：LLM 生成内容时，卡片会实时更新显示。
- **加载指示**：输出过程中显示"正在输入..."指示器。
- **需要配合**：需要在 AstrBot 中启用 LLM 流式输出功能。

### 5. 🔗 @ 提及转换
让 LLM 能够真正 @ 群成员。
- **智能识别**：当 LLM 回复中包含 `@张三` 时，自动转换为飞书原生的 @ 提及。
- **群成员匹配**：基于群成员列表进行精确匹配，确保 @ 到正确的人。

### 6. 😀 原生表情回复工具
赋予 LLM 使用飞书原生表情（Reactions）的能力。
- **情感表达**：模型可以使用工具给用户的消息贴上 👍、❤️、😂 等表情。
- **防刷屏**：每条消息最多只能添加一个表情回复。

### 7. 🧹 上下文清洗
针对 Gemini 等模型对 `tool_calls` 格式敏感的问题，插件会自动清洗历史上下文中的工具调用记录，将其转换为模型易读的文本描述，避免 API 报错。

## ⚙️ 配置说明

插件支持通过 AstrBot 仪表盘或直接修改配置文件进行配置。

| 配置项 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `enable_real_name` | bool | `true` | 是否启用真实姓名解析 |
| `enable_quoted_content` | bool | `true` | 是否启用引用消息内容注入 |
| `enable_group_info` | bool | `true` | 是否注入群组信息（群名、群描述） |
| `enable_context_cleaner` | bool | `true` | 是否启用上下文清洗（推荐开启，尤其是使用 Gemini 时） |
| `enable_streaming_card` | bool | `false` | 是否启用流式卡片输出（打字机效果），需要 LLM 启用流式输出 |
| `enable_mention_convert` | bool | `true` | 是否将 LLM 回复中的 @名字 转换为飞书 @ 提及 |
| `history_inject_count` | int | `20` | 群聊历史记录数量，设置为 0 可禁用 |
| `bot_name` | string | `"助手"` | 机器人在群聊历史记录中显示的名称 |

## 🚀 安装与使用

1. 将本插件目录放入 AstrBot 的 `data/plugins/` 目录下。
2. 安装依赖：`pip install -r requirements.txt`
3. 重启 AstrBot。
4. 在仪表盘中激活插件（通常自动激活）。
5. 在飞书群聊中 @机器人 即可体验增强后的效果。

## ⚠️ 注意事项

- **权限要求**：为了获取真实昵称和群成员信息，飞书机器人应用需要开通相应的 API 权限：
  - `contact:user.base:readonly` - 获取用户基本信息
  - `im:chat:readonly` - 获取群组信息
  - `im:chat.member:readonly` - 获取群成员列表
  - `im:message:readonly` - 获取消息内容
- **流式输出**：使用流式卡片功能前，请确保在 AstrBot 的 LLM 配置中启用了流式输出。
- **数据存储**：群聊历史记录存储在 `data/group_history.json` 文件中。

## 📝 License

MIT
